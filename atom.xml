<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Liyuliang&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://liyuliang.cc/"/>
  <updated>2018-11-30T10:15:33.000Z</updated>
  <id>https://liyuliang.cc/</id>
  
  <author>
    <name>Liyuliang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>How To Change Tmux Prefix Keymap In Iterm2</title>
    <link href="https://liyuliang.cc/2018/04/03/How-To-Change-Tmux-Prefix-Keymap-In-Iterm2/"/>
    <id>https://liyuliang.cc/2018/04/03/How-To-Change-Tmux-Prefix-Keymap-In-Iterm2/</id>
    <published>2018-04-03T04:59:22.000Z</published>
    <updated>2018-11-30T10:15:33.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sw_vers </span><br><span class="line">ProductName:Mac OS X</span><br><span class="line">ProductVersion:10.12.3</span><br><span class="line"></span><br><span class="line">$ tmux -V</span><br><span class="line">tmux 2.8</span><br><span class="line"></span><br><span class="line">$ Iterm2</span><br><span class="line">Build 3.2.5</span><br></pre></td></tr></table></figure><a id="more"></a><p>Default Prefix Key is <code>Ctrl</code> + <code>B</code>. I think it is too hard to press this combination button before next command.<br>Can i change the prefix key ?<br>According to the official document, the solution is inseparable from the <code>Ctrl</code> button. It means that <code>Ctrl</code> must be one of the prefix key.</p><p>But fortunately under mac, if you are using <code>Iterm</code> instead of system terminal, you can customize the key combination to mapping tmux ‘s prefix through by <code>Hex Code</code> </p><h3 id="Configuration-In-Item2"><a href="#Configuration-In-Item2" class="headerlink" title="Configuration In Item2:"></a>Configuration In Item2:</h3><blockquote><p>Preferences -&gt; Profiles -&gt; Keys</p></blockquote><h3 id="Add-A-new-Key-Mapping"><a href="#Add-A-new-Key-Mapping" class="headerlink" title="Add A new Key Mapping"></a>Add A new Key Mapping</h3><p>The Action choose <code>Send Hex Code</code><br>After recording the keyboard shortcut. You can set the mapping shortcut by hex code.<br>The key <code>Ctrl b</code> ‘s hex code is 0x02.<br>The next things becomes simpler.<br>Let me give an example. If you want to achieve the effect to mapping <code>Ctrl B</code> + <code>w</code>, you can entry the hex code <code>0x02 0x77</code> </p><p>Here i have search a example picture, you can compare it to get more information to build your own unique shortcut!<br><img src="/images/itemconfig.png" alt="Example Keys"></p><h3 id="More-Hex-Code"><a href="#More-Hex-Code" class="headerlink" title="More Hex Code"></a>More Hex Code</h3><p>You can check this <a href="https://www.cisco.com/c/en/us/td/docs/ios/12_2/configfun/command/reference/ffun_r/frf019.pdf" target="_blank" rel="noopener">ASCII Mapping Keyboard Table</a> to look for the hex code which you need.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sw_vers &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductName:	Mac OS X&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductVersion:	10.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ tmux -V&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;tmux 2.8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ Iterm2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Build 3.2.5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Mac" scheme="https://liyuliang.cc/tags/Mac/"/>
    
      <category term="Iterm" scheme="https://liyuliang.cc/tags/Iterm/"/>
    
      <category term="tmux" scheme="https://liyuliang.cc/tags/tmux/"/>
    
  </entry>
  
  <entry>
    <title>How to use &#39;time.After&#39; and &#39;default&#39; in Golang</title>
    <link href="https://liyuliang.cc/2018/03/26/How-to-use-time-After-and-default-in-Golang/"/>
    <id>https://liyuliang.cc/2018/03/26/How-to-use-time-After-and-default-in-Golang/</id>
    <published>2018-03-26T05:40:48.000Z</published>
    <updated>2018-10-26T08:24:22.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sw_vers </span><br><span class="line">ProductName:Mac OS X</span><br><span class="line">ProductVersion:10.12.3</span><br><span class="line"></span><br><span class="line">$ go version</span><br><span class="line">go version go1.11.1 darwin/amd64</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Interrupted-by-signal"><a href="#Interrupted-by-signal" class="headerlink" title="Interrupted by signal"></a>Interrupted by signal</h3><p>In the process of using goroutine, <code>for{}</code> is often used to maintain some long-term work. We will control the exit by sending signals to control the goroutine.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select &#123;</span><br><span class="line">    case &lt;-ch: </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>When <code>ch channel</code> receives a signal, the <code>for{}</code> loop can be terminated by <code>break</code>.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">    for &#123;</span><br><span class="line">        select &#123;</span><br><span class="line"></span><br><span class="line">        case &lt;-stopChan:</span><br><span class="line">            log.Println(&quot;Receive stop sign, stop loop. &quot;)</span><br><span class="line">            break loop</span><br><span class="line">        &#125;</span><br><span class="line">        case &lt;-ch2:</span><br><span class="line">            // do something </span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>When there are multiple <code>case</code>, <code>select</code> will randomly select a <code>case</code> to execute. At this time, <code>select</code> will block, until that the selected <code>case</code> is finished, and other <code>case</code> will not be executed.<br>But it’s easy to see the code in the selected <code>case</code> run for a long time, which seriously affects the execution of other <code>case</code>. This time you need to have timeout logic.</p><h3 id="Timeout-interrupt-loop"><a href="#Timeout-interrupt-loop" class="headerlink" title="Timeout interrupt loop"></a>Timeout interrupt loop</h3><p>In some scenarios, the loop should be time controlled. For example, in one of the cases, the network request timed out.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for &#123;</span><br><span class="line">       select &#123;</span><br><span class="line">       case &lt;-ch:</span><br><span class="line">           // http get timeout</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p><p>Of course, you can also add a timeout attribute to the http request to ensure the timeliness of the network request. But here we use <code>time.After</code> to complete it.<br>First look at its structure<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// After waits for the duration to elapse and then sends the current time</span><br><span class="line">// on the returned channel.</span><br><span class="line">// It is equivalent to NewTimer(d).C.</span><br><span class="line">// The underlying Timer is not recovered by the garbage collector</span><br><span class="line">// until the timer fires. If efficiency is a concern, use NewTimer</span><br><span class="line">// instead and call Timer.Stop if the timer is no longer needed.</span><br><span class="line">func After(d Duration) &lt;-chan Time &#123;</span><br><span class="line">return NewTimer(d).C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>This function will return a <code>channel</code>, which is exactly what <code>select{}</code> <code>case</code> needs.<br><code>time.After()</code> returns a channel message of type Time.<br>Based on this function, it is equivalent to the implementation of the timer, and is <code>non-blocking</code>.</p><p>Then the code should look like this:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">    for &#123;</span><br><span class="line">    select &#123;</span><br><span class="line">            case &lt;-time.After(60 * time.Second):</span><br><span class="line">                log.Println(&quot;Time to stop. &quot;)</span><br><span class="line">                break loop</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p><p>Exiting the loop after 60 seconds, it looks very simple, right?</p><h3 id="‘time-After’-and-‘default’-used-together"><a href="#‘time-After’-and-‘default’-used-together" class="headerlink" title="‘time.After’ and ‘default’ used together"></a>‘time.After’ and ‘default’ used together</h3><p>In <code>select{}</code>, not only <code>case</code>, but also a <code>default</code> keyword.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select &#123;</span><br><span class="line">    default:</span><br><span class="line">        // do default thing</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Go back to the previous example, if the limit loop is executed for up to 1 minute.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">    for &#123;</span><br><span class="line">           select &#123;</span><br><span class="line">           case &lt;-ch1:</span><br><span class="line">               // do something 1</span><br><span class="line">           case &lt;-ch2:</span><br><span class="line">               // do something 2</span><br><span class="line">               </span><br><span class="line">           case &lt;-time.After(60 * time.Second):</span><br><span class="line">               log.Println(&quot;Time %d to stop. &quot;)</span><br><span class="line">               break loop</span><br><span class="line">                                   </span><br><span class="line">           default:</span><br><span class="line">               // do default thing</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><p>The code doesn’t seem to have any problems, but when executed, it will be found that the loop will not be aborted!<br><code>case &lt;-time.After(60 * time.Second):</code> has no work!<br>Why?</p><p>We can see inside the <code>time.After</code> function, which is actually return a new timer channel.<br>In the code above, each time you execute <code>time.After(60 * time.Second)</code> you create a new timer channel.<br>There’s no way the select statement can remember the channel it selected on in the previous iteration.</p><p>Now that you know the reason, then the next step is how to update these code.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">timeout := time.After(60 * time.Second)</span><br><span class="line">loop:</span><br><span class="line">     for &#123;</span><br><span class="line">            select &#123;</span><br><span class="line">            case &lt;-ch1:</span><br><span class="line">                // do something 1</span><br><span class="line">            case &lt;-ch2:</span><br><span class="line">                // do something 2</span><br><span class="line">                </span><br><span class="line">            case &lt;-timeout:</span><br><span class="line">                log.Println(&quot;Time %d to stop. &quot;)</span><br><span class="line">                break loop</span><br><span class="line">                                    </span><br><span class="line">            default:</span><br><span class="line">                // do default thing</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>Very simple, right?<br><code>select</code> default is blocked, define a timer type channel outside the loop, this time <code>select{}</code> is also fair to select one of the channel to execute.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sw_vers &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductName:	Mac OS X&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductVersion:	10.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go version go1.11.1 darwin/amd64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="golang" scheme="https://liyuliang.cc/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Omitmepty in Golang</title>
    <link href="https://liyuliang.cc/2018/03/08/Omitmepty-in-Golang/"/>
    <id>https://liyuliang.cc/2018/03/08/Omitmepty-in-Golang/</id>
    <published>2018-03-08T08:00:53.000Z</published>
    <updated>2018-09-11T01:44:29.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sw_vers </span><br><span class="line">ProductName:    Mac OS X</span><br><span class="line">ProductVersion: 10.12.6</span><br><span class="line">BuildVersion:   16G29</span><br><span class="line"></span><br><span class="line">$ go version</span><br><span class="line">go version go1.8.3 darwin/amd64</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Omitempty-Behavior"><a href="#Omitempty-Behavior" class="headerlink" title="Omitempty Behavior"></a>Omitempty Behavior</h3><p>We often use <code>json</code> to serialize an object. In some scenarios, we only need to pass a property with a value. At this time we will use the omitempty property.</p><p>Read the official documentation for the encoding/json package and we will find a description of the omitempty behavior:</p><blockquote><p>Struct values encode as JSON objects. Each exported struct field becomes a member of the object unless</p><p>the field’s tag is “-“, or<br>the field is empty and its tag specifies the “omitempty” option.<br>The empty values are false, 0, any nil pointer or interface value, and any array, slice, map, or string of length zero. The object’s default key string is the struct field name but can be specified in the struct field’s tag value. The “json” key in the struct field’s tag value is the key name, followed by an optional comma and options. Examples:</p></blockquote><p>The role of omitempty is to ignore this field when serializing JSON when the value of a field is empty.</p><p>What needs to be noted here is the definition of empty.</p><blockquote><p>The empty values are false, 0, any nil pointer or interface value, and any array, slice, map, or string of length zero.</p></blockquote><p>A simple example will help better understand<br><figure class="highlight golang hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line"><span class="hljs-string">"encoding/json"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> people <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span></span><br><span class="line">AccountBalance <span class="hljs-keyword">float32</span> <span class="hljs-string">`json:"balance"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">p := <span class="hljs-built_in">new</span>(people)</span><br><span class="line">p.Name = <span class="hljs-string">"liyuliang"</span></span><br><span class="line"></span><br><span class="line">json,_ := json.Marshal(p)</span><br><span class="line"><span class="hljs-built_in">println</span>(<span class="hljs-keyword">string</span>(json))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>The result is that my account balance is 0.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;name&quot;:&quot;liyuliang&quot;,&quot;money&quot;:0&#125;</span><br></pre></td></tr></table></figure></p><p>When the property AccountBalance is added with omitempty<br><figure class="highlight golang hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">type</span> people <span class="hljs-keyword">struct</span> &#123;</span><br><span class="line">Name  <span class="hljs-keyword">string</span> <span class="hljs-string">`json:"name"`</span></span><br><span class="line">Money <span class="hljs-keyword">float32</span> <span class="hljs-string">`json:"money,omitempty"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>I don’t even have an account!!<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;name&quot;:&quot;liyuliang&quot;&#125;</span><br></pre></td></tr></table></figure></p><p>What a impressive property! Isn’t it?</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sw_vers &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductName:    Mac OS X&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductVersion: 10.12.6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BuildVersion:   16G29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go version go1.8.3 darwin/amd64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="golang" scheme="https://liyuliang.cc/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang meet &#39;float64bits redeclared in this block&#39;</title>
    <link href="https://liyuliang.cc/2018/02/22/Golang-meet-float64bits-redeclared-in-this-block/"/>
    <id>https://liyuliang.cc/2018/02/22/Golang-meet-float64bits-redeclared-in-this-block/</id>
    <published>2018-02-22T10:53:54.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 14.04 LTS</span><br><span class="line"></span><br><span class="line">$ go version</span><br><span class="line">go version go1.8 linux/amd64</span><br></pre></td></tr></table></figure><a id="more"></a><p>I have meet this error <code>usr/local/go/src/runtime/float.go:45: float64bits redeclared in this block</code><br>after update golang version from 1.8 to 1.9</p><p>Don’t worry, delete the go directory and re-install golang, problem will be fixed.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rm -rf /usr/local/go</span><br></pre></td></tr></table></figure></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s https://storage.googleapis.com/golang/go$&#123;GO_VERSION&#125;.linux-amd64.tar.gz | tar -v -C /usr/local -xz</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 14.04 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ go version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;go version go1.8 linux/amd64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="golang" scheme="https://liyuliang.cc/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>How to push multi repositories in same project</title>
    <link href="https://liyuliang.cc/2018/02/11/How-to-push-multi-repositories-in-same-project/"/>
    <id>https://liyuliang.cc/2018/02/11/How-to-push-multi-repositories-in-same-project/</id>
    <published>2018-02-11T05:50:39.000Z</published>
    <updated>2018-08-28T06:22:58.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sw_vers</span><br><span class="line">ProductName:Mac OS X</span><br><span class="line">ProductVersion:10.12.3</span><br><span class="line">BuildVersion:16D30</span><br><span class="line"></span><br><span class="line">$ git --version</span><br><span class="line">git version 2.18.0</span><br></pre></td></tr></table></figure><a id="more"></a><p>I recently created a outsourcing project that needs to submit the project code to empolyer’s github repository,<br>But i want to save the project in my private repository at the same time, so i thick i can submit it to two repositories<br>at the same time when i push the git.<br>Here is my personal code repository <a href="https://gitee.com/" target="_blank" rel="noopener"><code>gitee</code></a>.</p><h3 id="The-first-step-create-a-new-repository"><a href="#The-first-step-create-a-new-repository" class="headerlink" title="The first step, create a new repository"></a>The first step, create a new repository</h3><p>It named <code>https://gitee.com/liyuliang/xxxx</code><br>Be careful not to check the option <code>Use Readme file to initialize this project</code> (使用Readme文件初始化这个项目)<br>The first time i checked this option, i got an error when git pushing </p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">To gitee.com:liyuliang/xxxx.git</span><br><span class="line"> ! [rejected]        master -&gt; master (fetch first)</span><br><span class="line">error: failed to push some refs to &apos;git@gitee.com:liyuliang/xxxx.git&apos;</span><br><span class="line">hint: Updates were rejected because the remote contains work that you do</span><br><span class="line">hint: not have locally. This is usually caused by another repository pushing</span><br><span class="line">hint: to the same ref. You may want to first integrate the remote changes</span><br><span class="line">hint: (e.g., &apos;git pull ...&apos;) before pushing again.</span><br><span class="line">hint: See the &apos;Note about fast-forwards&apos; in &apos;git push --help&apos; for details.</span><br></pre></td></tr></table></figure><h3 id="Second-Add-a-git-repository-in-your-project"><a href="#Second-Add-a-git-repository-in-your-project" class="headerlink" title="Second, Add a git repository in your project"></a>Second, Add a git repository in your project</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git remote set-url --add origin git@gitee.com:liyuliang/xxxx.git</span><br></pre></td></tr></table></figure><p>The project git config file looks like this<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat .git/config </span><br><span class="line">[core]</span><br><span class="line">repositoryformatversion = 0</span><br><span class="line">filemode = true</span><br><span class="line">bare = false</span><br><span class="line">logallrefupdates = true</span><br><span class="line">ignorecase = true</span><br><span class="line">precomposeunicode = true</span><br><span class="line">[remote &quot;origin&quot;]</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">url = git@github:liyuliang/xxxx.git</span><br><span class="line">url = git@gitee.com:liyuliang/xxxx.git</span><br><span class="line">[branch &quot;master&quot;]</span><br><span class="line">remote = origin</span><br><span class="line">merge = refs/heads/master</span><br></pre></td></tr></table></figure></p><h3 id="The-Last-push-your-code-to-all-your-repositories"><a href="#The-Last-push-your-code-to-all-your-repositories" class="headerlink" title="The Last, push your code to all your repositories"></a>The Last, push your code to all your repositories</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push --all</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sw_vers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductName:	Mac OS X&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductVersion:	10.12.3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BuildVersion:	16D30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ git --version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;git version 2.18.0&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="git" scheme="https://liyuliang.cc/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>How to upload a picture url&#39;s content by form POST without local storage in Golang</title>
    <link href="https://liyuliang.cc/2018/02/03/How-to-upload-a-picture-url-s-content-by-form-POST-without-local-storage-in-Golang/"/>
    <id>https://liyuliang.cc/2018/02/03/How-to-upload-a-picture-url-s-content-by-form-POST-without-local-storage-in-Golang/</id>
    <published>2018-02-03T13:43:25.000Z</published>
    <updated>2018-08-01T04:07:45.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 16.04 LTS</span><br><span class="line"></span><br><span class="line"># go version</span><br><span class="line">  go version go1.8.4 linux/amd64</span><br></pre></td></tr></table></figure><a id="more"></a><p>Recently, i want to download a few pictures as my souvenirs, but these pictures all comes from other people’s website link.<br>And i have a personal image server which have form post api.<br>So this program will finished these steps in this tutorial with a few line code.</p><ul><li>Download a picture and save in memory temporary as byte buffer</li><li>Generate a post form and include picture ‘s information and content</li><li>Http request to image server</li></ul><p><code>The key is to set a new multipart.Writer</code></p><h3 id="Download-a-picture"><a href="#Download-a-picture" class="headerlink" title="Download a picture"></a>Download a picture</h3><p>It ‘s so sample to do this.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resp, err := req.Get(imageUrl)</span><br></pre></td></tr></table></figure><h3 id="Init-a-empty-byte-buffer"><a href="#Init-a-empty-byte-buffer" class="headerlink" title="Init a empty byte buffer"></a>Init a empty byte buffer</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">body = &amp;bytes.Buffer&#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="Init-a-writer"><a href="#Init-a-writer" class="headerlink" title="Init a writer"></a>Init a writer</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writer := multipart.NewWriter(body)</span><br></pre></td></tr></table></figure><p>The <code>mime/multipart</code> package hides all the complexity of creating a multipart request.</p><h3 id="Create-a-writer-form-and-init-a-fired-for-picture"><a href="#Create-a-writer-form-and-init-a-fired-for-picture" class="headerlink" title="Create a writer form and init a fired for picture"></a>Create a writer form and init a fired for picture</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">writerField, err := writer.CreateFormField(&quot;file&quot;)</span><br></pre></td></tr></table></figure><p>Create a part for the file form entry with the name of the file param and the name of the file.</p><h3 id="Translate-the-picture-as-byte-buffer"><a href="#Translate-the-picture-as-byte-buffer" class="headerlink" title="Translate the picture as byte buffer"></a>Translate the picture as byte buffer</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_, err = io.Copy(writerField, resp.Response().Body)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return body, &quot;&quot;, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">writer.Close()</span><br></pre></td></tr></table></figure><p>We need to add the content of the file to the file part, we use the <code>io.Copy()</code> to do so.<br>The <code>multipart.Writer</code> takes care of setting the boundary and formatting the form data for us, nice isn’t it?!</p><ul><li>Don’t forget to close our writer.</li></ul><h3 id="One-last-thing-before-post-form-request-you-should-know-the-form-content-type"><a href="#One-last-thing-before-post-form-request-you-should-know-the-form-content-type" class="headerlink" title="One last thing before post form request, you should know the form content type"></a>One last thing before post form request, you should know the form content type</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contentType := writer.FormDataContentType()</span><br></pre></td></tr></table></figure><h3 id="New-a-Post-form-request"><a href="#New-a-Post-form-request" class="headerlink" title="New a Post form request"></a>New a Post form request</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request, err := http.NewRequest(&quot;POST&quot;, apiUrl, body)</span><br><span class="line">request.Header.Set(&quot;Content-Type&quot;, contentType)</span><br></pre></td></tr></table></figure><h3 id="Send-this-request"><a href="#Send-this-request" class="headerlink" title="Send this request"></a>Send this request</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">response, err := client.Do(request)</span><br></pre></td></tr></table></figure><p>This tutorial is written based on <code>Static file upload</code>.<br>Hopefully this example will be helpful to some of you.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 16.04 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;# go version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  go version go1.8.4 linux/amd64&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="golang" scheme="https://liyuliang.cc/tags/golang/"/>
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>How Symfony create entity class from mysql database</title>
    <link href="https://liyuliang.cc/2018/01/25/How-Symfony-create-entity-class-from-mysql-database/"/>
    <id>https://liyuliang.cc/2018/01/25/How-Symfony-create-entity-class-from-mysql-database/</id>
    <published>2018-01-25T07:45:04.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat composer.json</span><br><span class="line">    ...</span><br><span class="line">    &quot;require&quot;: &#123;</span><br><span class="line">           &quot;php&quot;: &quot;&gt;=5.5.9&quot;,</span><br><span class="line">           &quot;symfony/symfony&quot;: &quot;2.8.*&quot;,</span><br><span class="line">           ...</span><br><span class="line">       &#125;,</span><br><span class="line">       </span><br><span class="line">$ mysqld -V</span><br><span class="line"> mysqld  Ver 5.7.18 for Linux on x86_64 (MySQL Community Server (GPL))</span><br></pre></td></tr></table></figure><a id="more"></a><p>In some case, you will meet a secondary development project based on mysql.It has a complete database and your new project bases on Symfony framework.<br>As you know, if there are entities mapping class will speed up your development. So this is why this tutorial exist.   </p><p>First of all: this converter doesn’t support some basic MySQL data types by default, so you have to edit your app/config/config.yml file as follows:</p><h3 id="Update-Doctrine-Configuration"><a href="#Update-Doctrine-Configuration" class="headerlink" title="Update Doctrine Configuration"></a>Update Doctrine Configuration</h3><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">doctrine:</span></span><br><span class="line"><span class="hljs-attr">    dbal:</span></span><br><span class="line"><span class="hljs-attr">        mapping_types:</span></span><br><span class="line"><span class="hljs-attr">            enum:</span> <span class="hljs-string">string</span></span><br><span class="line"><span class="hljs-attr">            bit:</span> <span class="hljs-string">integer</span></span><br></pre></td></tr></table></figure><p>You might need to add some other types, too.<br>As Doctrine does not support any of these: </p><blockquote><p>BIT, BINARY, VARBINARY, TINYBLOB, MEDIUMBLOB, BLOB, LONGBLOB, ENUM, SET, GEOMETRY, POINT, MULTIPOINT, LINESTRING, MULTILINESTRING, POLYGON, MULTIPOLYGON.</p></blockquote><h3 id="Make-sure-all-tables-have-primary-keys"><a href="#Make-sure-all-tables-have-primary-keys" class="headerlink" title="Make sure all tables have primary keys"></a>Make sure all tables have primary keys</h3><p>OK, that might sound obvious.<br>But I real had some tables without the key.</p><h3 id="Generate-the-mapping-file"><a href="#Generate-the-mapping-file" class="headerlink" title="Generate the mapping file"></a>Generate the mapping file</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php app/console doctrine:mapping:import --force AppBundle xml -vvv</span><br></pre></td></tr></table></figure><h3 id="Generate-Entities-under-directory-‘src-AppBundle-Entity’"><a href="#Generate-Entities-under-directory-‘src-AppBundle-Entity’" class="headerlink" title="Generate Entities under directory ‘src/AppBundle/Entity’"></a>Generate Entities under directory ‘src/AppBundle/Entity’</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php app/console doctrine:mapping:convert annotation ./src</span><br></pre></td></tr></table></figure><h3 id="Generate-the-Get-and-Set-method-in-entity"><a href="#Generate-the-Get-and-Set-method-in-entity" class="headerlink" title="Generate the Get and Set method in entity"></a>Generate the Get and Set method in entity</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php app/console generate:doctrine:entities AppBundle</span><br></pre></td></tr></table></figure><p>Ok, entities will all be done! </p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat composer.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;quot;require&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &amp;quot;php&amp;quot;: &amp;quot;&amp;gt;=5.5.9&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           &amp;quot;symfony/symfony&amp;quot;: &amp;quot;2.8.*&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;           ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ mysqld -V&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; mysqld  Ver 5.7.18 for Linux on x86_64 (MySQL Community Server (GPL))&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Mysql" scheme="https://liyuliang.cc/tags/Mysql/"/>
    
      <category term="Symfony" scheme="https://liyuliang.cc/tags/Symfony/"/>
    
  </entry>
  
  <entry>
    <title>Vertically Scrollable In Div Element Using CSS </title>
    <link href="https://liyuliang.cc/2018/01/19/Vertically-Scrollable-In-Div-Element-Using-CSS/"/>
    <id>https://liyuliang.cc/2018/01/19/Vertically-Scrollable-In-Div-Element-Using-CSS/</id>
    <published>2018-01-19T08:00:03.000Z</published>
    <updated>2018-08-01T04:07:45.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="My-computer-develop-environment"><a href="#My-computer-develop-environment" class="headerlink" title="My computer develop environment"></a>My computer develop environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sw_vers </span><br><span class="line">ProductName:    Mac OS X</span><br><span class="line">ProductVersion: 10.12.6</span><br><span class="line">BuildVersion:   16G29</span><br><span class="line"></span><br><span class="line">Chrome</span><br><span class="line">67.0.3396.99（64 bit）</span><br></pre></td></tr></table></figure><a id="more"></a><p>Today I want to share a method that limit div height and view its content by scrolling if content ‘s length is too much for current screen height.</p><p>First your should make sure the height you want, and set it in div <code>style</code> </p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=&quot;height:100%;&quot;&gt;</span><br></pre></td></tr></table></figure><p>Next, fixed it being vertical direction in the screen and make it can be scroll.<br>The core code is <code>overflow-y: scroll;</code></p><h4 id="At-last-the-complete-code-is-as-follow"><a href="#At-last-the-complete-code-is-as-follow" class="headerlink" title="At last, the complete code is as follow"></a>At last, the complete code is as follow</h4><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div style=&quot;overflow-y: scroll; height:100%;&quot;&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;My-computer-develop-environment&quot;&gt;&lt;a href=&quot;#My-computer-develop-environment&quot; class=&quot;headerlink&quot; title=&quot;My computer develop environment&quot;&gt;&lt;/a&gt;My computer develop environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ sw_vers &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductName:    Mac OS X&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ProductVersion: 10.12.6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;BuildVersion:   16G29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Chrome&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;67.0.3396.99（64 bit）&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="css" scheme="https://liyuliang.cc/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>How To Storage Session By Redis In Symfony2</title>
    <link href="https://liyuliang.cc/2018/01/17/How-To-Storage-Session-By-Redis-In-Symfony2/"/>
    <id>https://liyuliang.cc/2018/01/17/How-To-Storage-Session-By-Redis-In-Symfony2/</id>
    <published>2018-01-17T07:54:37.000Z</published>
    <updated>2018-12-17T09:38:09.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-Environment"><a href="#Server-Environment" class="headerlink" title="Server Environment"></a>Server Environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 16.04.2 LTS \n \l</span><br><span class="line"></span><br><span class="line">$ redis-server --version</span><br><span class="line">Redis server v=3.0.6 sha=00000000:0 malloc=jemalloc-3.6.0 bits=64</span><br><span class="line"></span><br><span class="line">$ cat composer.json</span><br><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">       &quot;php&quot;: &quot;&gt;=5.5.9&quot;,</span><br><span class="line">       &quot;symfony/symfony&quot;: &quot;2.8.*&quot;,</span><br><span class="line">       ...</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Using-Redis-instead-of-the-default-PHP-file-storage-session"><a href="#Using-Redis-instead-of-the-default-PHP-file-storage-session" class="headerlink" title="Using Redis instead of the default PHP file storage session"></a>Using Redis instead of the default PHP file storage session</h3><p>For the first preparation, we need to have a running Redis service.</p><p>Then, installing php redis extension. This tutorial bases on the Ubuntu:16.04 system, so i will use command <code>apt install</code>  to do this.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y php-redis</span><br></pre></td></tr></table></figure></p><p>Next, find the <code>config.yml</code> in your Symfony project and register the session handler which named <code>session_handler_redis</code>.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim app/config/config.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-attr">framework:</span></span><br><span class="line">    <span class="hljs-string">...</span></span><br><span class="line"><span class="hljs-attr">    session:</span></span><br><span class="line">        <span class="hljs-comment"># handler_id set to null will use default session handler from php.ini</span></span><br><span class="line"><span class="hljs-comment">#        handler_id:  ~</span></span><br><span class="line"><span class="hljs-attr">        handler_id:</span> <span class="hljs-string">session_handler_redis</span></span><br></pre></td></tr></table></figure><p>This configuration uses a new session handler to figure out the session service. </p><p>Now we can declare a Symfony Service in <code>services.yml</code>.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim app/config/services.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-attr">services:</span></span><br><span class="line">    <span class="hljs-string">...</span></span><br><span class="line"><span class="hljs-attr">    session_handler_redis:</span></span><br><span class="line"><span class="hljs-attr">         class:</span> <span class="hljs-string">AppBundle\SessionHandler\NativeRedisSessionHandler</span></span><br><span class="line"><span class="hljs-attr">         arguments:</span> <span class="hljs-string">["%session_handler_redis_scheme%","%session_handler_redis_host%","%session_handler_redis_port%","%session_handler_redis_auth%","%session_guest_life_seconds%"]</span></span><br></pre></td></tr></table></figure><p>How can we manage the session in these new  handler <code>AppBundle\SessionHandler\NativeRedisSessionHandler</code> ?<br>There are a lot of tools on github that can do this, but I found that there is already such code in the Symfony source to help us do this.</p><p>So declare a new file named <code>NativeRedisSessionHandler</code> in your project:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim src/AppBundle/SessionHandler/NativeRedisSessionHandler.php</span><br></pre></td></tr></table></figure></p><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="hljs-comment"> * User: liang</span></span><br><span class="line"><span class="hljs-comment"> * Date: 18年01月17日</span></span><br><span class="line"><span class="hljs-comment"> * Time: 下午12:07</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppBundle</span>\<span class="hljs-title">SessionHandler</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> \<span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Session</span>\<span class="hljs-title">Storage</span>\<span class="hljs-title">Handler</span>\<span class="hljs-title">NativeSessionHandler</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * NativeRedisSessionStorage.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * Driver for the redis session &lt;div id="R77EHMs" style="position: absolute; top: -1183px; left: -1358px; width: 243px;"&gt;&lt;/div&gt; save hadlers provided by the redis PHP extension.</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> https://github.com/nicolasff/phpredis</span></span><br><span class="line"><span class="hljs-comment"> *</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Andrej Hudec &amp;lt;pulzarraider<span class="hljs-doctag">@gmail</span>.com&amp;gt;</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Piotr Pelczar &amp;lt;me<span class="hljs-doctag">@athlan</span>.pl&amp;gt;</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NativeRedisSessionHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NativeSessionHandler</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Constructor.</span></span><br><span class="line"><span class="hljs-comment">     *</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> string $host Path of redis server.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> string $scheme</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> int $port</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> null $auth</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> int $saveTime</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($scheme, $host, $port = <span class="hljs-number">6379</span>, $auth = null, $saveTime = <span class="hljs-number">1440</span>)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">if</span> (!extension_loaded(<span class="hljs-string">'redis'</span>)) &#123;</span><br><span class="line">            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \RuntimeException(<span class="hljs-string">'PHP does not have "redis" session module registered'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> ($host) &#123;</span><br><span class="line"></span><br><span class="line">            $savePath = <span class="hljs-string">"&#123;$scheme&#125;://&#123;$host&#125;:&#123;$port&#125;"</span>;</span><br><span class="line">            <span class="hljs-keyword">if</span> ($auth)&#123;</span><br><span class="line">                $savePath = <span class="hljs-string">"&#123;$savePath&#125;?auth=&#123;$auth&#125;"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ini_set(<span class="hljs-string">'session.save_handler'</span>, <span class="hljs-string">'redis'</span>);</span><br><span class="line">            ini_set(<span class="hljs-string">'session.save_path'</span>, $savePath);</span><br><span class="line">            ini_set(<span class="hljs-string">'session.gc_maxlifetime'</span>, $saveTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>That’s all! How simple it is!</p><h3 id="Restrict-account-logins-by-controlling-sessions"><a href="#Restrict-account-logins-by-controlling-sessions" class="headerlink" title="Restrict account logins by controlling sessions"></a>Restrict account logins by controlling sessions</h3><p>In some business contexts, user accounts should not be allowed to log in to multiple devices at the same time.<br>When an account is logged in to a new device, the old account session should be cleaned up.<br>We can maintain a new key map to control the session. For example, uniqueAccount - sessionId.</p><p>In order to control redis more conveniently, we need to install the package about redis. Here we use the <a href="https://github.com/nrk/predis" target="_blank" rel="noopener">predis</a>.<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">    ...</span><br><span class="line">    &quot;snc/redis-bundle&quot;: &quot;2.1&quot;,</span><br><span class="line">    &quot;predis/predis&quot;: &quot;^1.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Then we add a new record in redis which key is user unique account and value is the sessionId after login success.<br>However, it should be noted that you need to first find and <code>delete all</code> corresponding sessionIds through the account, and then generate a new session record.</p><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * <span class="hljs-doctag">@Route</span>("/login/success",name="login_success")</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loginSuccessAction</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    $CurrentUser = <span class="hljs-keyword">$this</span>-&gt;getCurrentUser();</span><br><span class="line">    $Client = <span class="hljs-keyword">new</span> \Predis\Client([</span><br><span class="line">        <span class="hljs-string">'scheme'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getParameter(<span class="hljs-string">'session_handler_redis_scheme'</span>),</span><br><span class="line">        <span class="hljs-string">'host'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getParameter(<span class="hljs-string">'session_handler_redis_host'</span>),</span><br><span class="line">        <span class="hljs-string">'port'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getParameter(<span class="hljs-string">'session_handler_redis_port'</span>),</span><br><span class="line">        <span class="hljs-string">'password'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;getParameter(<span class="hljs-string">'session_handler_redis_auth'</span>),</span><br><span class="line">    ]);</span><br><span class="line">    $sessionId = $Client-&gt;get($CurrentUser-&gt;account());</span><br><span class="line">    <span class="hljs-keyword">if</span> ($sessionId) &#123;</span><br><span class="line">        $Client-&gt;del([$CurrentUser-&gt;account(), $sessionId]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $session = <span class="hljs-keyword">$this</span>-&gt;get(<span class="hljs-string">'session'</span>);</span><br><span class="line">    $session-&gt;start();</span><br><span class="line">    $sessionId = <span class="hljs-string">"PHPREDIS_SESSION:"</span> . $session-&gt;getId();</span><br><span class="line"></span><br><span class="line">    $Client-&gt;set($CurrentUser-&gt;account(), $sessionId);</span><br><span class="line">    $Client-&gt;expire($sessionId, <span class="hljs-keyword">$this</span>-&gt;getParameter(<span class="hljs-string">'session_user_life_seconds'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok, after this step, repeat account login limit is completed too.</p><h3 id="Clear-Session-record-if-logout"><a href="#Clear-Session-record-if-logout" class="headerlink" title="Clear Session record if logout"></a>Clear Session record if logout</h3><p>Default logout method in Symfony is declared in the firewall configuration. When we need to customize the behavior of this account logout, we need to declare a new handler.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim app/config/security.yml</span><br></pre></td></tr></table></figure><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-attr">security:</span></span><br><span class="line"><span class="hljs-attr">    firewalls:</span></span><br><span class="line">        <span class="hljs-string">...</span></span><br><span class="line"><span class="hljs-attr">        main:</span></span><br><span class="line">            <span class="hljs-string">...</span></span><br><span class="line"><span class="hljs-attr">            logout:</span></span><br><span class="line"><span class="hljs-comment">#                path: /logout</span></span><br><span class="line"><span class="hljs-comment">#                target: /</span></span><br><span class="line"><span class="hljs-attr">                handlers:</span> <span class="hljs-string">[app.webservice_logout_listener]</span></span><br></pre></td></tr></table></figure><p>First, we should register a new logout service<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim app/config/services.yml</span><br></pre></td></tr></table></figure></p><figure class="highlight yaml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-attr">services:</span></span><br><span class="line">    <span class="hljs-string">...</span></span><br><span class="line">    <span class="hljs-string">app.webservice_logout_listener:</span></span><br><span class="line"><span class="hljs-attr">        class:</span> <span class="hljs-string">AppBundle\Security\LogoutListener</span></span><br><span class="line"><span class="hljs-attr">        arguments:</span> <span class="hljs-string">["%session_handler_redis_scheme%","%session_handler_redis_host%","%session_handler_redis_port%","%session_handler_redis_auth%","%session_guest_life_seconds%"]</span></span><br></pre></td></tr></table></figure><p>And this listener will clear all session by current login user’s account.<br><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"><span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="hljs-comment"> * User: liyuliang</span></span><br><span class="line"><span class="hljs-comment"> * Date: 17/01/2018</span></span><br><span class="line"><span class="hljs-comment"> * Time: 3:17 PM</span></span><br><span class="line"><span class="hljs-comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppBundle</span>\<span class="hljs-title">Security</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">AppBundle</span>\<span class="hljs-title">Controller</span>\<span class="hljs-title">me</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Request</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">HttpFoundation</span>\<span class="hljs-title">Response</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Security</span>\<span class="hljs-title">Core</span>\<span class="hljs-title">Authentication</span>\<span class="hljs-title">Token</span>\<span class="hljs-title">TokenInterface</span>;</span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">Symfony</span>\<span class="hljs-title">Component</span>\<span class="hljs-title">Security</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Logout</span>\<span class="hljs-title">LogoutHandlerInterface</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LogoutListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogoutHandlerInterface</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">use</span> <span class="hljs-title">me</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> $scheme;</span><br><span class="line">    <span class="hljs-keyword">private</span> $host;</span><br><span class="line">    <span class="hljs-keyword">private</span> $port;</span><br><span class="line">    <span class="hljs-keyword">private</span> $auth;</span><br><span class="line">    <span class="hljs-keyword">private</span> $saveTime;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($scheme, $host, $port = <span class="hljs-number">6379</span>, $auth = null, $saveTime = <span class="hljs-number">1440</span>)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;scheme = $scheme;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;host = $host;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;port = $port;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;auth = $auth;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;saveTime = $saveTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * This method is called by the LogoutListener when a user has requested</span></span><br><span class="line"><span class="hljs-comment">     * to be logged out. Usually, you would unset session variables, or remove</span></span><br><span class="line"><span class="hljs-comment">     * cookies, etc.</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> Request $request</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> Response $response</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> TokenInterface $token</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span><span class="hljs-params">(Request $request, Response $response, TokenInterface $token)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        $user = $token-&gt;getUser();</span><br><span class="line"></span><br><span class="line">        $Client = <span class="hljs-keyword">new</span> \Predis\Client([</span><br><span class="line">            <span class="hljs-string">'scheme'</span> =&gt; <span class="hljs-string">'tcp'</span>,</span><br><span class="line">            <span class="hljs-string">'host'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;host,</span><br><span class="line">            <span class="hljs-string">'port'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;port,</span><br><span class="line">            <span class="hljs-string">'password'</span> =&gt; <span class="hljs-keyword">$this</span>-&gt;auth,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $sessionId = $Client-&gt;get($user-&gt;getUsername());</span><br><span class="line">        <span class="hljs-keyword">if</span> ($sessionId) &#123;</span><br><span class="line">            $Client-&gt;del([$user-&gt;getUsername(), $sessionId]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-Environment&quot;&gt;&lt;a href=&quot;#Server-Environment&quot; class=&quot;headerlink&quot; title=&quot;Server Environment&quot;&gt;&lt;/a&gt;Server Environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 16.04.2 LTS \n \l&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ redis-server --version&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Redis server v=3.0.6 sha=00000000:0 malloc=jemalloc-3.6.0 bits=64&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ cat composer.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;quot;require&amp;quot;: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;quot;php&amp;quot;: &amp;quot;&amp;gt;=5.5.9&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       &amp;quot;symfony/symfony&amp;quot;: &amp;quot;2.8.*&amp;quot;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;,&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="Symfony" scheme="https://liyuliang.cc/tags/Symfony/"/>
    
      <category term="Redis" scheme="https://liyuliang.cc/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>How to install EduSoho in Ubuntu</title>
    <link href="https://liyuliang.cc/2018/01/03/How-to-install-EduSoho-in-Ubuntu/"/>
    <id>https://liyuliang.cc/2018/01/03/How-to-install-EduSoho-in-Ubuntu/</id>
    <published>2018-01-03T15:11:41.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 14.04.5 LTS</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Install-nginx"><a href="#Install-nginx" class="headerlink" title="Install nginx"></a>Install nginx</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y nginx</span><br></pre></td></tr></table></figure><h3 id="Config-Nginx"><a href="#Config-Nginx" class="headerlink" title="Config Nginx"></a>Config Nginx</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><p>Add this in http{} field<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client_max_body_size 1024M;</span><br></pre></td></tr></table></figure></p><h3 id="Install-mysql"><a href="#Install-mysql" class="headerlink" title="Install mysql"></a>Install mysql</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y mysql-server</span><br></pre></td></tr></table></figure><h3 id="Create-database"><a href="#Create-database" class="headerlink" title="Create database"></a>Create database</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -uroot -p</span><br></pre></td></tr></table></figure><h3 id="Create-edusoho-database-add-database-user"><a href="#Create-edusoho-database-add-database-user" class="headerlink" title="Create edusoho database, add database user"></a>Create edusoho database, add database user</h3><figure class="highlight sql hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-string">`edusoho`</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 ; </span><br><span class="line"><span class="hljs-keyword">GRANT</span> ALL <span class="hljs-keyword">PRIVILEGES</span> <span class="hljs-keyword">ON</span> <span class="hljs-string">`edusoho`</span>.* <span class="hljs-keyword">TO</span> <span class="hljs-string">'esuser'</span>@<span class="hljs-string">'localhost'</span> <span class="hljs-keyword">IDENTIFIED</span> <span class="hljs-keyword">BY</span> <span class="hljs-string">'edusoho'</span>;</span><br></pre></td></tr></table></figure><p>username: esuser<br>password: edusoho</p><h3 id="Install-PHP"><a href="#Install-PHP" class="headerlink" title="Install PHP"></a>Install PHP</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get -y install php5 php5-cli php5-curl php5-fpm php5-intl php5-mcrypt php5-mysqlnd php5-gd</span><br></pre></td></tr></table></figure><h3 id="Change-PHP-file-upload-size-limit"><a href="#Change-PHP-file-upload-size-limit" class="headerlink" title="Change PHP file upload size limit"></a>Change PHP file upload size limit</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/php5/fpm/php.ini</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">post_max_size = 1024M </span><br><span class="line">memory_limit = 1024M</span><br><span class="line">upload_max_filesize = 1024M</span><br></pre></td></tr></table></figure><h3 id="Config-PHP-FPM"><a href="#Config-PHP-FPM" class="headerlink" title="Config PHP-FPM"></a>Config PHP-FPM</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/php5/fpm/pool.d/www.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">;listen.owner = www-data</span><br><span class="line">;listen.group = www-data</span><br><span class="line">;listen.mode = 0660</span><br></pre></td></tr></table></figure><p>Remove the semicolon then restart PHP-FPM<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /etc/init.d/php5-fpm restart</span><br></pre></td></tr></table></figure></p><h3 id="Install-EduSoho"><a href="#Install-EduSoho" class="headerlink" title="Install EduSoho"></a>Install EduSoho</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -s</span><br><span class="line">$ mkdir -p /var/www</span><br><span class="line">$ cd /var/www</span><br><span class="line">$ wget http://download.edusoho.com/edusoho-8.2.5.tar.gz</span><br><span class="line">$ tar -zxvf edusoho-8.2.5.tar.gz</span><br><span class="line">$ chown www-data:www-data edusoho/ -Rf</span><br></pre></td></tr></table></figure><p>If this zip package can not download, please visit the edusoho home page for it.</p><h3 id="Configure-nginx-virtual-host"><a href="#Configure-nginx-virtual-host" class="headerlink" title="Configure nginx virtual host"></a>Configure nginx virtual host</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/nginx/sites-enabled/default</span><br></pre></td></tr></table></figure><p>Replace all its contents with following </p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    root /var/www/edusoho/web;</span><br><span class="line"></span><br><span class="line">    access_log /var/log/nginx/example.com.access.log;</span><br><span class="line">    error_log /var/log/nginx/example.com.error.log;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        index app.php;</span><br><span class="line">        try_files $uri @rewriteapp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location @rewriteapp &#123;</span><br><span class="line">        rewrite ^(.*)$ /app.php/$1 last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ ^/udisk &#123;</span><br><span class="line">        internal;</span><br><span class="line">        root /var/www/edusoho/app/data/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ ^/(app|app_dev)\.php(/|$) &#123;</span><br><span class="line">        fastcgi_pass   unix:/var/run/php5-fpm.sock;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param  HTTPS              off;</span><br><span class="line">        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;</span><br><span class="line">        fastcgi_param HTTP_X-Accel-Mapping /udisk=/var/www/edusoho/app/data/udisk;</span><br><span class="line">        fastcgi_buffer_size 128k;</span><br><span class="line">        fastcgi_buffers 8 128k;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* \.(jpg|jpeg|gif|png|ico|swf)$ &#123;</span><br><span class="line">        # three year expire time</span><br><span class="line">        expires 3y;</span><br><span class="line"></span><br><span class="line">        # close log record</span><br><span class="line">        access_log off;</span><br><span class="line"></span><br><span class="line">        # close gzip compression to reduce CPU pressure because the picture compression rate is low</span><br><span class="line">        gzip off;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~* \.(css|js)$ &#123;</span><br><span class="line">        access_log off;</span><br><span class="line">        expires 3y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # forbidden to access user upload file directory for security</span><br><span class="line">    location ~ ^/files/.*\.(php|php5)$ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   unix:/var/run/php5-fpm.sock;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param  HTTPS              off;</span><br><span class="line">        fastcgi_param  HTTP_PROXY         &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Restart-nginx"><a href="#Restart-nginx" class="headerlink" title="Restart nginx"></a>Restart nginx</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /etc/init.d/nginx restart</span><br></pre></td></tr></table></figure><p>Open you browse to visit <a href="http://localhost/" target="_blank" rel="noopener">http://localhost/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 14.04.5 LTS&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>PHP Singleton Mode</title>
    <link href="https://liyuliang.cc/2018/01/03/PHP-Singleton-Mode/"/>
    <id>https://liyuliang.cc/2018/01/03/PHP-Singleton-Mode/</id>
    <published>2018-01-03T08:56:12.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 16.04.2 LTS</span><br><span class="line">  </span><br><span class="line">$ php -v</span><br><span class="line">  PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )</span><br></pre></td></tr></table></figure><a id="more"></a><p>The Real One and Modern way to make Singleton Pattern is:</p><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">Class</span> <span class="hljs-title">Singleton</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Singleton constructor.</span></span><br><span class="line"><span class="hljs-comment">     * Make constructor private. so nobody can call "new Class".</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Make clone magic method private. so nobody can clone instance.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__clone</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Make sleep magic method private. so nobody can serialize instance.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Make wakeup magic method private. so nobody can unserialize instance.</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * Call this method to get singleton</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> static</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Instance</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">static</span> $instance = <span class="hljs-keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">if</span> ($instance === <span class="hljs-keyword">false</span>) &#123;</span><br><span class="line">            $instance = <span class="hljs-keyword">new</span> <span class="hljs-keyword">static</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="hljs-keyword">return</span> $instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>So now you can use it like.</p><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Database</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Singleton</span></span></span><br><span class="line"><span class="hljs-class"></span>&#123;</span><br><span class="line">    <span class="hljs-keyword">protected</span> $label;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> mixed</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLabel</span><span class="hljs-params">()</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;label;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">/**</span></span><br><span class="line"><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> mixed $label</span></span><br><span class="line"><span class="hljs-comment">     */</span></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setLabel</span><span class="hljs-params">($label)</span></span></span><br><span class="line"><span class="hljs-function">    </span>&#123;</span><br><span class="line">        <span class="hljs-keyword">$this</span>-&gt;label = $label;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Test it<br><figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$database = Database::Instance();</span><br><span class="line">$database-&gt;setLabel(<span class="hljs-string">"Liang-app"</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> $database-&gt;getLabel() . PHP_EOL;   <span class="hljs-comment">//Liang-app</span></span><br><span class="line"></span><br><span class="line">$other_db = Database::Instance();</span><br><span class="line"><span class="hljs-keyword">echo</span> $other_db-&gt;getLabel() . PHP_EOL;   <span class="hljs-comment">//Liang-app</span></span><br><span class="line"></span><br><span class="line">$other_db-&gt;setLabel(<span class="hljs-string">"Liang-app-2"</span>);</span><br><span class="line"><span class="hljs-keyword">echo</span> $database-&gt;getLabel() . PHP_EOL;   <span class="hljs-comment">//Liang-app-2</span></span><br><span class="line"><span class="hljs-keyword">echo</span> $other_db-&gt;getLabel() . PHP_EOL;   <span class="hljs-comment">//Liang-app-2</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 16.04.2 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="https://liyuliang.cc/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>Fail2ban Pass Mysql Remote Login through</title>
    <link href="https://liyuliang.cc/2018/01/01/Fail2ban-Pass-Mysql-Remote-Login-through/"/>
    <id>https://liyuliang.cc/2018/01/01/Fail2ban-Pass-Mysql-Remote-Login-through/</id>
    <published>2018-01-01T04:53:01.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 14.04.5 LTS</span><br><span class="line"></span><br><span class="line">$ fail2ban-server -V</span><br><span class="line">Fail2Ban v0.8.11</span><br></pre></td></tr></table></figure><a id="more"></a><p>Recently, I found that there are many ssh attack in the auth.log.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat /var/log/auth.log | grep ssh2</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">Jan  1 01:20:49 app sshd[22438]: Failed password for root from 59.55.140.173 port 16421 ssh2</span><br><span class="line">Jan  1 01:27:22 app sshd[22440]: Failed password for invalid user snort from 91.121.112.123 port 33773 ssh2</span><br><span class="line">Jan  1 01:58:52 app sshd[22459]: Failed password for invalid user admin from 196.219.96.116 port 53758 ssh2</span><br><span class="line">Jan  1 01:59:01 app sshd[22461]: Failed password for invalid user admin from 14.170.244.58 port 42785 ssh2</span><br><span class="line">Jan  1 02:05:25 app sshd[22466]: Failed password for invalid user vmail from 5.135.161.94 port 60876 ssh2</span><br><span class="line">Jan  1 02:08:04 app sshd[22468]: Failed password for invalid user test9 from 5.135.161.94 port 55094 ssh2</span><br><span class="line">Jan  1 02:10:52 app sshd[22483]: Failed password for invalid user oracle from 5.135.161.94 port 49413 ssh2</span><br></pre></td></tr></table></figure><p>So I decided to use <code>fail2ban</code> with <code>iptables</code> to limit this part of ip address to access.</p><h3 id="Check-The-Iptables"><a href="#Check-The-Iptables" class="headerlink" title="Check The Iptables"></a>Check The Iptables</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -nvL</span><br><span class="line"></span><br><span class="line">Chain INPUT (policy ACCEPT 1850K packets, 353M bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 1786K packets, 571M bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination</span><br></pre></td></tr></table></figure><h3 id="Add-Iptables-Rules"><a href="#Add-Iptables-Rules" class="headerlink" title="Add Iptables Rules"></a>Add Iptables Rules</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/iptables.my.rules</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">*filter</span><br><span class="line"></span><br><span class="line"># Allows all loopback (lo0) traffic and drop all traffic to 127/8 that doesn&apos;t use lo0</span><br><span class="line">-A INPUT -i lo -j ACCEPT</span><br><span class="line">-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT</span><br><span class="line"></span><br><span class="line"># Accepts all established inbound connections</span><br><span class="line">-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Allows all outbound traffic</span><br><span class="line"># You could modify this to only allow certain traffic</span><br><span class="line">-A OUTPUT -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Allows HTTP and HTTPS connections from anywhere (the normal ports for websites)</span><br><span class="line">-A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">-A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Allows SSH connections </span><br><span class="line"># The --dport number is the same as in /etc/ssh/sshd_config</span><br><span class="line">-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Allows Mysql connections</span><br><span class="line">-A INPUT -p tcp --dport 3306 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># Now you should read up on iptables rules and consider whether ssh access </span><br><span class="line"># for everyone is really desired. Most likely you will only allow access from certain IPs.</span><br><span class="line"></span><br><span class="line"># Allow ping</span><br><span class="line">#  note that blocking other types of icmp packets is considered a bad idea by some</span><br><span class="line">#  remove -m icmp --icmp-type 8 from this line to allow all kinds of icmp:</span><br><span class="line">#  https://security.stackexchange.com/questions/22711</span><br><span class="line">-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT</span><br><span class="line"></span><br><span class="line"># log iptables denied calls (access via &apos;dmesg&apos; command)</span><br><span class="line">-A INPUT -m limit --limit 5/min -j LOG --log-prefix &quot;iptables denied: &quot; --log-level 7</span><br><span class="line"></span><br><span class="line"># Reject all other inbound - default deny unless explicitly allowed policy:</span><br><span class="line">-A INPUT -j REJECT</span><br><span class="line">-A FORWARD -j REJECT</span><br><span class="line"></span><br><span class="line">COMMIT</span><br></pre></td></tr></table></figure><p>You can follow this example to add other applications port access like this Mysql(3306) port.</p><h3 id="Enable-This-Rules"><a href="#Enable-This-Rules" class="headerlink" title="Enable This Rules"></a>Enable This Rules</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-restore &lt; /etc/iptables.my.rules</span><br></pre></td></tr></table></figure><h3 id="Save-This-Rules"><a href="#Save-This-Rules" class="headerlink" title="Save This Rules"></a>Save This Rules</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables-save &gt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure><h3 id="Auto-Start-After-Boot"><a href="#Auto-Start-After-Boot" class="headerlink" title="Auto Start After Boot"></a>Auto Start After Boot</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/network/if-pre-up.d/iptables</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">/sbin/iptables-restore &lt; /etc/iptables.up.rules</span><br></pre></td></tr></table></figure><p>Add file execution permission<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x /etc/network/if-pre-up.d/iptables</span><br></pre></td></tr></table></figure></p><h3 id="Install-Fail2ban"><a href="#Install-Fail2ban" class="headerlink" title="Install Fail2ban"></a>Install Fail2ban</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install -y fail2ban</span><br></pre></td></tr></table></figure><h3 id="Copy-A-Jail-Config-file"><a href="#Copy-A-Jail-Config-file" class="headerlink" title="Copy A Jail Config file"></a>Copy A Jail Config file</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /etc/fail2ban  </span><br><span class="line">$ cp jail.conf jail.local</span><br></pre></td></tr></table></figure><h3 id="Change-This-Configuration"><a href="#Change-This-Configuration" class="headerlink" title="Change This Configuration"></a>Change This Configuration</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]</span><br><span class="line"></span><br><span class="line">### Continuous access in 600 seconds</span><br><span class="line">findtime = 600</span><br><span class="line"></span><br><span class="line">### Entry wrong password 2 times.</span><br><span class="line">maxretry = 2</span><br><span class="line"></span><br><span class="line">### Block access for 1 days.</span><br><span class="line">bantime  = 36000000</span><br><span class="line"></span><br><span class="line">backend = polling</span><br><span class="line">...</span><br><span class="line"># Choose default action.  To change, just override value of &apos;action&apos; with the</span><br><span class="line"># interpolation to the chosen action shortcut (e.g.  action_mw, action_mwl, etc) in jail.local</span><br><span class="line"># globally (section [DEFAULT]) or per specific section</span><br><span class="line">#action = %(action_)s</span><br><span class="line"></span><br><span class="line">action = iptables[name=SSH, port=ssh, protocol=tcp]</span><br></pre></td></tr></table></figure><h3 id="Start-Fail2ban"><a href="#Start-Fail2ban" class="headerlink" title="Start Fail2ban"></a>Start Fail2ban</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service fail2ban restart</span><br></pre></td></tr></table></figure><h3 id="Check-the-log-print"><a href="#Check-the-log-print" class="headerlink" title="Check the log print"></a>Check the log print</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail -f /var/log/fail2ban.log</span><br><span class="line"></span><br><span class="line">2018-01-01 04:44:39,853 fail2ban.jail   : INFO   Creating new jail &apos;ssh&apos;</span><br><span class="line">2018-01-01 04:44:39,853 fail2ban.jail   : INFO   Jail &apos;ssh&apos; uses poller</span><br><span class="line">2018-01-01 04:44:39,868 fail2ban.jail   : INFO   Initiated &apos;polling&apos; backend</span><br><span class="line">2018-01-01 04:44:39,869 fail2ban.filter : INFO   Added logfile = /var/log/auth.log</span><br><span class="line">2018-01-01 04:44:39,870 fail2ban.filter : INFO   Set maxRetry = 6</span><br><span class="line">2018-01-01 04:44:39,871 fail2ban.filter : INFO   Set findtime = 600</span><br><span class="line">2018-01-01 04:44:39,871 fail2ban.actions: INFO   Set banTime = 36000000</span><br><span class="line">2018-01-01 04:44:39,919 fail2ban.jail   : INFO   Jail &apos;ssh&apos; started</span><br><span class="line">2018-01-01 04:45:10,981 fail2ban.actions: WARNING [ssh] Ban 118.212.143.43</span><br><span class="line">2018-01-01 04:52:52,562 fail2ban.actions: WARNING [ssh] Ban 220.191.194.22</span><br></pre></td></tr></table></figure><h3 id="Check-Result-In-iptables"><a href="#Check-Result-In-iptables" class="headerlink" title="Check Result In iptables"></a>Check Result In iptables</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -nvL</span><br><span class="line">Chain INPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line"> 8468  549K fail2ban-SSH  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:22</span><br><span class="line">    0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">    0     0 REJECT     all  --  !lo    *       0.0.0.0/0            127.0.0.0/8          reject-with icmp-port-unreachable</span><br><span class="line">31873   13M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED</span><br><span class="line">    3   140 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class="line">  498 33053 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:443</span><br><span class="line">   13   764 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22</span><br><span class="line">   29  1740 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:3306</span><br><span class="line">    1    84 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0            icmptype 8</span><br><span class="line">  376  114K LOG        all  --  *      *       0.0.0.0/0            0.0.0.0/0            limit: avg 5/min burst 5 LOG flags 0 level 7 prefix &quot;iptables denied: &quot;</span><br><span class="line"> 1813  442K REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">31767   20M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain fail2ban-SSH (1 references)</span><br><span class="line"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class="line">   10   988 REJECT     all  --  *      *       220.191.194.22       0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line">  369 22140 REJECT     all  --  *      *       118.212.143.43       0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class="line"> 8089  525K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0</span><br></pre></td></tr></table></figure><p>You can see the part <code>Chain fail2ban-SSH (1 references)</code>, the fail2ban is working and filter 2 ip attack by iptables.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 14.04.5 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ fail2ban-server -V&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Fail2Ban v0.8.11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="iptable" scheme="https://liyuliang.cc/tags/iptable/"/>
    
  </entry>
  
  <entry>
    <title>Linux upload file to Baidu cloud disk</title>
    <link href="https://liyuliang.cc/2017/12/15/Linux-upload-file-to-Baidu-cloud-disk/"/>
    <id>https://liyuliang.cc/2017/12/15/Linux-upload-file-to-Baidu-cloud-disk/</id>
    <published>2017-12-15T13:27:32.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 16.04.2 LTS</span><br><span class="line"></span><br><span class="line">$ pip -V</span><br><span class="line">  pip 9.0.1 from /usr/local/lib/python2.7/dist-packages (python 2.7)</span><br><span class="line">  </span><br><span class="line">$ php -v</span><br><span class="line">  PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Install-bypy"><a href="#Install-bypy" class="headerlink" title="Install bypy"></a>Install bypy</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install requests bypy</span><br></pre></td></tr></table></figure><h3 id="Authorized-Login"><a href="#Authorized-Login" class="headerlink" title="Authorized Login"></a>Authorized Login</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bypy info</span><br><span class="line">Please visit:</span><br><span class="line">https://openapi.baidu.com/oauth/2.0/authorize?scope=basic+netdisk&amp;redirect_uri=oob&amp;response_type=code&amp;client_id=q8WE4EpCsau1oS0MplgMKNBn</span><br><span class="line">And authorize this app</span><br><span class="line">Paste the Authorization Code here within 10 minutes.</span><br><span class="line">Press [Enter] when you are done</span><br></pre></td></tr></table></figure><p>Visit the url then copy the code in terminal and entry<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc773b9b3884019d284b59c21fccf449</span><br></pre></td></tr></table></figure></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Authorizing, please be patient, it may take upto None seconds...</span><br><span class="line">Authorizing/refreshing with the OpenShift server ...</span><br><span class="line">OpenShift server failed, authorizing/refreshing with the Heroku server ...</span><br><span class="line">Successfully authorized</span><br><span class="line">Quota: 2.008TB</span><br><span class="line">Used: 192.089GB</span><br></pre></td></tr></table></figure><p>Authorized success.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bypy list</span><br><span class="line">/apps/bypy ($t $f $s $m $d):</span><br></pre></td></tr></table></figure><p>Limited by Baidu PCS api, files just can be accessed under the /apps/bypy directory in Baidu cloud disk    </p><h3 id="Upload-to-cloud-disk"><a href="#Upload-to-cloud-disk" class="headerlink" title="Upload to cloud disk"></a>Upload to cloud disk</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/data/</span><br><span class="line">$ bypy upload</span><br><span class="line">[____________________] 0% (85.2MB/1.3GB)</span><br></pre></td></tr></table></figure><p>All files under the data directory are uploading.</p><h3 id="Download-file-from-cloud-disk"><a href="#Download-file-from-cloud-disk" class="headerlink" title="Download file from cloud disk"></a>Download file from cloud disk</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bypy downdir</span><br></pre></td></tr></table></figure><p>Files under the directory /apps/bypy will be downloaded now.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 16.04.2 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ pip -V&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  pip 9.0.1 from /usr/local/lib/python2.7/dist-packages (python 2.7)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  PHP 7.0.22-0ubuntu0.16.04.1 (cli) ( NTS )&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="Baidu" scheme="https://liyuliang.cc/tags/Baidu/"/>
    
      <category term="CloudDisk" scheme="https://liyuliang.cc/tags/CloudDisk/"/>
    
  </entry>
  
  <entry>
    <title>Build Google Mirror By Nginx</title>
    <link href="https://liyuliang.cc/2017/12/15/Build-Google-Mirror-By-Nginx/"/>
    <id>https://liyuliang.cc/2017/12/15/Build-Google-Mirror-By-Nginx/</id>
    <published>2017-12-15T10:55:22.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-Environment"><a href="#Server-Environment" class="headerlink" title="Server Environment"></a>Server Environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 14.04.4 LTS</span><br><span class="line">$ nginx -v</span><br><span class="line">  nginx version: nginx/1.4.6 (Ubuntu)</span><br></pre></td></tr></table></figure><a id="more"></a><p>A simple demo to build a google mirror.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/nginx/sites-enabled/google.conf</span><br><span class="line"> </span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  _;</span><br><span class="line"> </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass https://www.google.com.hk;</span><br><span class="line">        proxy_connect_timeout 120;</span><br><span class="line">        proxy_read_timeout 600;</span><br><span class="line">        proxy_send_timeout 600;</span><br><span class="line"> </span><br><span class="line">        send_timeout 600;</span><br><span class="line">        proxy_redirect    off;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">           # proxy_set_header Host $host;</span><br><span class="line"> </span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-Environment&quot;&gt;&lt;a href=&quot;#Server-Environment&quot; class=&quot;headerlink&quot; title=&quot;Server Environment&quot;&gt;&lt;/a&gt;Server Environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 14.04.4 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ nginx -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  nginx version: nginx/1.4.6 (Ubuntu)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="nginx" scheme="https://liyuliang.cc/tags/nginx/"/>
    
      <category term="proxy" scheme="https://liyuliang.cc/tags/proxy/"/>
    
  </entry>
  
  <entry>
    <title>Nginx Add Request Host In Log Format</title>
    <link href="https://liyuliang.cc/2017/12/03/Nginx-Add-Request-Host-In-Log-Format/"/>
    <id>https://liyuliang.cc/2017/12/03/Nginx-Add-Request-Host-In-Log-Format/</id>
    <published>2017-12-03T08:58:06.000Z</published>
    <updated>2018-08-28T06:58:16.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 16.04.3 LTS</span><br><span class="line"></span><br><span class="line">$ nginx -v</span><br><span class="line">nginx version: nginx/1.10.3 (Ubuntu)</span><br></pre></td></tr></table></figure><a id="more"></a><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># cat nginx.conf </span><br><span class="line"></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">##</span><br><span class="line"># Logging Settings</span><br><span class="line">##</span><br><span class="line"></span><br><span class="line">log_format main &apos;$host - $remote_addr - [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                &apos;$status $upstream_response_time $request_time &quot;$http_referer&quot;&apos;</span><br><span class="line">                &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; $body_bytes_sent &apos;;</span><br><span class="line">access_log /var/log/nginx/access.log main;</span><br></pre></td></tr></table></figure><p>It only take effect that <code>main</code> in <code>access_log /var/log/nginx/access.log main;</code> match the log format name.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 16.04.3 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ nginx -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;nginx version: nginx/1.10.3 (Ubuntu)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="nginx" scheme="https://liyuliang.cc/tags/nginx/"/>
    
      <category term="log" scheme="https://liyuliang.cc/tags/log/"/>
    
  </entry>
  
  <entry>
    <title>How to Install docker-ce in Ubuntu17</title>
    <link href="https://liyuliang.cc/2017/11/29/How-to-Install-docker-ce-in-Ubuntu17/"/>
    <id>https://liyuliang.cc/2017/11/29/How-to-Install-docker-ce-in-Ubuntu17/</id>
    <published>2017-11-29T09:42:10.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 17.10</span><br><span class="line"></span><br><span class="line">$ docker -v</span><br><span class="line">Docker version 17.09.0-ce, build afdb6d4</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Install-using-the-repository"><a href="#Install-using-the-repository" class="headerlink" title="Install using the repository"></a>Install using the repository</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common</span><br></pre></td></tr></table></figure><h3 id="Add-Docker’s-official-GPG-key"><a href="#Add-Docker’s-official-GPG-key" class="headerlink" title="Add Docker’s official GPG key"></a>Add Docker’s official GPG key</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ sudo apt-key fingerprint 0EBFCD88</span><br><span class="line">$ sudo add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu zesty stable&quot;</span><br></pre></td></tr></table></figure><h3 id="Install-Docker-ce"><a href="#Install-Docker-ce" class="headerlink" title="Install Docker-ce"></a>Install Docker-ce</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br><span class="line">$ sudo apt-get install -y docker-ce</span><br></pre></td></tr></table></figure><h3 id="Update-registry-source"><a href="#Update-registry-source" class="headerlink" title="Update registry source"></a>Update registry source</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/systemd/system/multi-user.target.wants/docker.service</span><br></pre></td></tr></table></figure><p>Specified the registry source<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ExecStart=/usr/bin/dockerd -H fd://</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --registry-mirror=https://registry.docker-cn.com</span><br></pre></td></tr></table></figure></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service docker restart</span><br><span class="line">$ sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 17.10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ docker -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Docker version 17.09.0-ce, build afdb6d4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="docker" scheme="https://liyuliang.cc/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Composer Memory Limit</title>
    <link href="https://liyuliang.cc/2017/11/07/Composer-Memory-Limit/"/>
    <id>https://liyuliang.cc/2017/11/07/Composer-Memory-Limit/</id>
    <published>2017-11-07T09:48:58.000Z</published>
    <updated>2018-08-01T04:07:45.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">Ubuntu 16.04.1 LTS</span><br><span class="line"></span><br><span class="line">$ php -v</span><br><span class="line">PHP 7.0.30-0ubuntu0.16.04.1 (cli) ( NTS )</span><br></pre></td></tr></table></figure><a id="more"></a><p>Maybe you have been meet this problem<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Reading /home/ubuntu/.cache/....json from cache</span><br><span class="line">Reading /home/ubuntu/.cache/....json from cache</span><br><span class="line">Reading /home/ubuntu/.cache/....json from cache</span><br><span class="line">Killed</span><br></pre></td></tr></table></figure></p><p>Or<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">mmap() failed: [12] Cannot allocate memory</span><br><span class="line">PHP Fatal error:  Out of memory (allocated 762322944) (tried to allocate 20480 bytes) in phar:///usr/local/bin/composer/src/Composer/DependencyResolver/GenericRule.php on line 36</span><br><span class="line">Fatal error: Out of memory (allocated 762322944) (tried to allocate 20480 bytes) in phar:///usr/local/bin/composer/src/Composer/DependencyResolver/GenericRule.php on line 36</span><br></pre></td></tr></table></figure></p><p>These problems are all due to the need of memory during composer running.</p><p>Here are two solution.  </p><h3 id="Limit-PHP-Memory"><a href="#Limit-PHP-Memory" class="headerlink" title="Limit PHP Memory"></a>Limit PHP Memory</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/php/7.0/cli/php.ini</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory_limit = 1024M</span><br></pre></td></tr></table></figure><p><code>memory_limit</code> is not limited default in PHP.</p><h3 id="Increase-Virtual-Memory"><a href="#Increase-Virtual-Memory" class="headerlink" title="Increase Virtual Memory"></a>Increase Virtual Memory</h3><p>You can see my another <a href="/2017/09/18/How-to-Add-Virtual-Memory-In-Linux/">blog</a><br>It will show you how to increase the virtual memory in Ubuntu</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Ubuntu 16.04.1 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;PHP 7.0.30-0ubuntu0.16.04.1 (cli) ( NTS )&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="https://liyuliang.cc/tags/PHP/"/>
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="composer" scheme="https://liyuliang.cc/tags/composer/"/>
    
  </entry>
  
  <entry>
    <title>Nginx + Keepalived, high available load balance</title>
    <link href="https://liyuliang.cc/2017/10/23/Nginx-Keepalived-high-available-load-balance/"/>
    <id>https://liyuliang.cc/2017/10/23/Nginx-Keepalived-high-available-load-balance/</id>
    <published>2017-10-23T13:47:18.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 14.04.5 LTS</span><br><span class="line"></span><br><span class="line">$ nginx -v</span><br><span class="line">  nginx version: nginx/1.4.6 (Ubuntu)</span><br><span class="line">  </span><br><span class="line">$ apachectl -V</span><br><span class="line">  Server version: Apache/2.4.7 (Ubuntu)</span><br></pre></td></tr></table></figure><a id="more"></a><table><thead><tr><th style="text-align:left">Server</th><th style="text-align:center">Keepalived</th><th style="text-align:center">Virtual IP</th><th style="text-align:center">Upstream</th><th style="text-align:center">IP</th><th style="text-align:center">Web Port</th></tr></thead><tbody><tr><td style="text-align:left">Nginx 1</td><td style="text-align:center">Master</td><td style="text-align:center">192.168.33.150</td><td style="text-align:center">WebSite 1、WebSite 2</td><td style="text-align:center">192.168.33.1</td><td style="text-align:center">9001</td></tr><tr><td style="text-align:left">Nginx 2</td><td style="text-align:center">Backup</td><td style="text-align:center">192.168.33.150</td><td style="text-align:center">WebSite 1、WebSite 2</td><td style="text-align:center">192.168.33.2</td><td style="text-align:center">9002</td></tr><tr><td style="text-align:left">WebSite 1</td><td style="text-align:center">–</td><td style="text-align:center">–</td><td style="text-align:center">–</td><td style="text-align:center">192.168.33.11</td><td style="text-align:center">8011</td></tr><tr><td style="text-align:left">WebSite 2</td><td style="text-align:center">–</td><td style="text-align:center">–</td><td style="text-align:center">–</td><td style="text-align:center">192.168.33.12</td><td style="text-align:center">8011</td></tr></tbody></table><h3 id="Install-Nginx"><a href="#Install-Nginx" class="headerlink" title="Install Nginx"></a>Install Nginx</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y nginx</span><br></pre></td></tr></table></figure><h3 id="Nginx-configuration"><a href="#Nginx-configuration" class="headerlink" title="Nginx configuration"></a>Nginx configuration</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd /etc/nginx/sites-enabled/</span><br><span class="line">$ sudo rm -f default </span><br><span class="line">$ sudo vim site.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">upstream apache &#123;</span><br><span class="line">    server 192.168.33.11:8011 weight=1;</span><br><span class="line">    server 192.168.33.12:8011 weight=1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  server_name _</span><br><span class="line">  listen 80;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://apache;</span><br><span class="line">    proxy_set_header X-NGINX &quot;NGINX-1&quot;;     // Just add a header info to distinguish</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Restart nginx<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service nginx restart</span><br></pre></td></tr></table></figure></p><h3 id="Install-Keepalived"><a href="#Install-Keepalived" class="headerlink" title="Install Keepalived"></a>Install Keepalived</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y keepalived</span><br></pre></td></tr></table></figure><h3 id="Config-Keepalived"><a href="#Config-Keepalived" class="headerlink" title="Config Keepalived"></a>Config Keepalived</h3><p>Nginx Master <code>192.168.33.1</code> :</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot; //check nginx process script </span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">      //something to notify by mail</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER                           // Mark this one is the master server</span><br><span class="line">    interface eth0                         // Your NIC &apos;s name</span><br><span class="line">    virtual_router_id 51                   // Virtual router, whether master or backup keepalived, it must be the same</span><br><span class="line">    mcast_src_ip 192.168.33.1              // Master nginx machine &apos;s ip</span><br><span class="line">    priority 250                           // Master priority must higher than backup</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456                // Password for communication in keepalived</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.33.150                  // Virtual public ip </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Check nginx process script<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash  </span><br><span class="line">A=`ps -C nginx --no-header |wc -l`</span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line"> /etc/init.d/nginx start</span><br><span class="line"> sleep 3</span><br><span class="line"> if [ `ps -C nginx --no-header |wc -l`-eq 0 ];then</span><br><span class="line">  killall keepalived</span><br><span class="line"> fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>Nginx Slave <code>192.168.33.2</code> :</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/keepalived/keepalived.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_nginx.sh&quot; //check nginx process script </span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    notification_email &#123;</span><br><span class="line">      //something to notify by mail</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP                           // Mark this one is the backup server</span><br><span class="line">    interface eth0                         // Your NIC &apos;s name</span><br><span class="line">    virtual_router_id 51                   // Virtual router, whether master or backup keepalived, it must be the same</span><br><span class="line">    mcast_src_ip 192.168.33.2              // Slace nginx machine &apos;s ip</span><br><span class="line">    priority 240                           // Master priority must higher than backup</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 123456                    // Password for communication in keepalived</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.33.150                      // Virtual public ip </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Check nginx process script<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/keepalived/check_nginx.sh</span><br></pre></td></tr></table></figure></p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash  </span><br><span class="line">A=`ps -C nginx --no-header |wc -l`</span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line"> /etc/init.d/nginx start</span><br><span class="line"> sleep 3</span><br><span class="line"> if [ `ps -C nginx --no-header |wc -l`-eq 0 ];then</span><br><span class="line">  killall keepalived</span><br><span class="line"> fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><h3 id="Start-Keepalived-And-Check-the-process"><a href="#Start-Keepalived-And-Check-the-process" class="headerlink" title="Start Keepalived And Check the process"></a>Start Keepalived And Check the process</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service keepalived start</span><br><span class="line">$ ps aux | grep keepalived</span><br><span class="line">$ ps -ef | grep nginx</span><br></pre></td></tr></table></figure><h3 id="Check-Virtual-IP-192-168-33-150-Has-Been-Bound"><a href="#Check-Virtual-IP-192-168-33-150-Has-Been-Bound" class="headerlink" title="Check Virtual IP (192.168.33.150) Has Been Bound"></a>Check Virtual IP (192.168.33.150) Has Been Bound</h3><p><code>192.168.33.1</code><br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:80:6e:f8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.2.15/24 brd 10.0.2.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.33.150/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a00:27ff:fe80:6ef8/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p><p>Look at <code>line 12</code>, the virtual ip is bound on this machine.</p><p>Also try on backup server <code>192.168.33.2</code>.</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ip add</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default </span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:80:6e:f8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.2.15/24 brd 10.0.2.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::a00:27ff:fe80:6ef8/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>You can find that <code>the virtual IP is not bound to the backup server</code>.</p><h3 id="Visit-The-Virtual-Public-IP"><a href="#Visit-The-Virtual-Public-IP" class="headerlink" title="Visit The Virtual Public IP"></a>Visit The Virtual Public IP</h3><p>Visit this link several times to check if there is any change<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://192.168.33.150</span><br></pre></td></tr></table></figure></p><h3 id="Keepalived-Non-Preempt-Mode"><a href="#Keepalived-Non-Preempt-Mode" class="headerlink" title="Keepalived Non-Preempt Mode"></a>Keepalived Non-Preempt Mode</h3><p>Change Keepalived configuration</p><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_instance VI_1 &#123;  </span><br><span class="line">    state BACKUP        // All machines&apos; state change to &apos;BACKUP&apos;</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    nopreempt           // Add non-preempt mode keyword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The master keepalived machine is decided by priority</p><h3 id="The-Meaning-Of-Non-Preempt-Mode"><a href="#The-Meaning-Of-Non-Preempt-Mode" class="headerlink" title="The Meaning Of Non-Preempt Mode"></a>The Meaning Of Non-Preempt Mode</h3><p><code>MASTER</code> provides service, <code>BACKUP</code> waiting.<br><code>MASTER</code> crash, <code>BACKUP</code> provides service instead of <code>MASTER</code>.<br><code>MASTER</code> resume, <code>MASTER</code> waiting, <code>BACKUP</code> still provides service.<br><code>BACKUP</code> crash, <code>MASTER</code> rebinds virtual IP and provides service.</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 14.04.5 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ nginx -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  nginx version: nginx/1.4.6 (Ubuntu)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ apachectl -V&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Server version: Apache/2.4.7 (Ubuntu)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="https://liyuliang.cc/tags/Ubuntu/"/>
    
      <category term="nginx" scheme="https://liyuliang.cc/tags/nginx/"/>
    
      <category term="Slave" scheme="https://liyuliang.cc/tags/Slave/"/>
    
      <category term="Keepalived" scheme="https://liyuliang.cc/tags/Keepalived/"/>
    
  </entry>
  
  <entry>
    <title>Install Supervisor For A PHP Script</title>
    <link href="https://liyuliang.cc/2017/10/11/Install-Supervisor-For-A-PHP-Script/"/>
    <id>https://liyuliang.cc/2017/10/11/Install-Supervisor-For-A-PHP-Script/</id>
    <published>2017-10-11T10:25:45.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 14.04.5 LTS</span><br><span class="line"></span><br><span class="line">$ supervisord -v</span><br><span class="line">  3.0b2</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="Install-Supervisor"><a href="#Install-Supervisor" class="headerlink" title="Install Supervisor"></a>Install Supervisor</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y supervisor</span><br></pre></td></tr></table></figure><h3 id="Add-A-New-Supervisor-Config-File"><a href="#Add-A-New-Supervisor-Config-File" class="headerlink" title="Add A New Supervisor Config File"></a>Add A New Supervisor Config File</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/supervisor/conf.d/php-script.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[program:updateGoods]</span><br><span class="line">directory = /www</span><br><span class="line">command=/usr/bin/php bin/console update:goods</span><br><span class="line">process_name = %(program_name)s_%(process_num)02d</span><br><span class="line">numprocs = 1</span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">startsecs=1</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes = 0,2</span><br><span class="line">redirect_stderr=true</span><br><span class="line">stopsignal = QUIT</span><br><span class="line">stopwaitsecs = 10</span><br><span class="line">stopasgroup=true</span><br><span class="line">stdout_logfile=/www/log/update.goodes.log</span><br><span class="line">user=daemon</span><br><span class="line">environment = SYMFONY_ENV=prod</span><br><span class="line"></span><br><span class="line">[supervisord]</span><br><span class="line">nodaemon=true</span><br><span class="line"></span><br><span class="line">[supervisorctl]</span><br></pre></td></tr></table></figure><p>Here, I have a Symfony3 project under the <code>/www</code> directory, I hope the supervisor can start running a php script by command <code>php bin/console update:goods</code><br>if supervisor startup.<br><code>numprocs</code> means it will start one process and <code>stopsignal</code> means that it will send a quit signal to this php process before supervisor stop<br><code>nodaemon</code> under <code>[supervisord]</code> is very helpful if you use the <code>docker</code> to manager your container.</p><h3 id="Start-Supervisor-Service"><a href="#Start-Supervisor-Service" class="headerlink" title="Start Supervisor Service"></a>Start Supervisor Service</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service supervisor start</span><br></pre></td></tr></table></figure><h3 id="Check-The-PHP-running-status"><a href="#Check-The-PHP-running-status" class="headerlink" title="Check The PHP running status"></a>Check The PHP running status</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo supervisorctl status</span><br><span class="line">app:updateGoods_00                 RUNNING   pid 7, uptime 0:44:12</span><br></pre></td></tr></table></figure><p>or you can using this commands to control these process<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo supervisorctl stop app:updateGoods_00</span><br><span class="line">$ sudo supervisorctl start app:updateGoods_00</span><br><span class="line">$ sudo supervisorctl restart app:updateGoods_00</span><br></pre></td></tr></table></figure></p><h3 id="Something-wrong-i-meet"><a href="#Something-wrong-i-meet" class="headerlink" title="Something wrong i meet"></a>Something wrong i meet</h3><p>After first time i start the supervisor service. I saw these errors in my project error.<br>It means that the user (<code>user=daemon</code>) in supervisor config file can not access the /www directory.<br>So you can update the config <code>user=root</code> to fix this problem<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@app:~# tail -f /www/log/update.goodes.log </span><br><span class="line">supervisor: couldn&apos;t chdir to /www: EACCES</span><br><span class="line">supervisor: child process was not spawned</span><br><span class="line">supervisor: couldn&apos;t chdir to /www: EACCES</span><br><span class="line">supervisor: child process was not spawned</span><br><span class="line">supervisor: couldn&apos;t chdir to /www: EACCES</span><br><span class="line">supervisor: child process was not spawned</span><br><span class="line">supervisor: couldn&apos;t chdir to /www: EACCES</span><br><span class="line">supervisor: child process was not spawned</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 14.04.5 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ supervisord -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  3.0b2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="https://liyuliang.cc/tags/PHP/"/>
    
      <category term="supervisor" scheme="https://liyuliang.cc/tags/supervisor/"/>
    
      <category term="Daemon" scheme="https://liyuliang.cc/tags/Daemon/"/>
    
  </entry>
  
  <entry>
    <title>Run PHP Script As Daemon Service</title>
    <link href="https://liyuliang.cc/2017/10/11/Run-PHP-Script-As-Daemon-Service/"/>
    <id>https://liyuliang.cc/2017/10/11/Run-PHP-Script-As-Daemon-Service/</id>
    <published>2017-10-11T10:15:28.000Z</published>
    <updated>2018-07-11T09:32:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Server-environment"><a href="#Server-environment" class="headerlink" title="Server environment"></a>Server environment</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/issue</span><br><span class="line">  Ubuntu 14.04.5 LTS</span><br><span class="line"></span><br><span class="line">$ php -v</span><br><span class="line">  PHP 5.6.32-1+ubuntu14.04.1+deb.sury.org+2 (cli)</span><br></pre></td></tr></table></figure><a id="more"></a><p>How to run php script as daemon process?</p><h3 id="Nohup"><a href="#Nohup" class="headerlink" title="Nohup"></a>Nohup</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup php script.php &amp;</span><br></pre></td></tr></table></figure><h3 id="Upstart"><a href="#Upstart" class="headerlink" title="Upstart"></a>Upstart</h3><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim /etc/init/myphpworker.conf</span><br></pre></td></tr></table></figure><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">start on startup</span><br><span class="line">stop on shutdown</span><br><span class="line"></span><br><span class="line">respawn</span><br><span class="line">respawn limit 20 5</span><br><span class="line"></span><br><span class="line">script</span><br><span class="line">  exec /usr/bin/php -f /app/script.php</span><br><span class="line">end script</span><br></pre></td></tr></table></figure><p>or you can check the php script if return error then stop this service<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">script</span><br><span class="line">    [ $(exec /usr/bin/php -f /app/script.php) = &apos;ERROR&apos; ] &amp;&amp; ( stop; exit 1; )</span><br><span class="line">end script</span><br></pre></td></tr></table></figure></p><ul><li>If /app/script.php echo a “ERROR” string ,this service will stop</li></ul><p>Check this service status<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service myphpworker status</span><br><span class="line">myphpworker stop/waiting</span><br><span class="line"></span><br><span class="line">$ sudo service myphpworker start</span><br><span class="line">myphpworker start/running, process 2648</span><br></pre></td></tr></table></figure></p><p>Check the script output log<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo tail -f /var/log/upstart/myphpworker.log </span><br><span class="line">welcome</span><br><span class="line">welcome</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><p>The php script demo<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;welcome&quot;. PHP_EOL;</span><br></pre></td></tr></table></figure></p><h3 id="Supervisor"><a href="#Supervisor" class="headerlink" title="Supervisor"></a>Supervisor</h3><p>You can see my another <a href="/2017/10/11/Install-Supervisor-For-A-PHP-Script/" target="_blank">blog</a></p><h3 id="Start-stop-daemon"><a href="#Start-stop-daemon" class="headerlink" title="Start-stop-daemon"></a>Start-stop-daemon</h3><p><code>start-stop-daemon</code> is a linux tool</p><p>I have wrote a demo and the demo directory is like this<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/home/vagrant/start-stop-daemon</span><br><span class="line"></span><br><span class="line"># ls -lh</span><br><span class="line">total 8.0K</span><br><span class="line">-rw-rw-r-- 1 vagrant vagrant  59 Jul  11 18:29 a.php</span><br><span class="line">-rwxr-xr-x 1 root    root    791 Jul  11 18:29 run</span><br></pre></td></tr></table></figure></p><p>The <strong>run</strong> script file:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#! /bin/sh</span><br><span class="line"></span><br><span class="line">DAEMON=/usr/bin/php</span><br><span class="line">DAEMON_OPTS=&apos;/home/vagrant/start-stop-daemon/a.php&apos;</span><br><span class="line">NAME=&apos;daemon-demo&apos;</span><br><span class="line">DESC=&apos;daemon-demo&apos;</span><br><span class="line">PIDFILE=&quot;/var/run/$&#123;NAME&#125;.pid&quot;</span><br><span class="line">QUIET=&quot;--quiet&quot;</span><br><span class="line">START_OPTS=&quot;--start $&#123;QUIET&#125; --background --make-pidfile --pidfile $&#123;PIDFILE&#125; --exec $&#123;DAEMON&#125; $&#123;DAEMON_OPTS&#125;&quot;</span><br><span class="line">STOP_OPTS=&quot;--stop --pidfile $&#123;PIDFILE&#125;&quot;</span><br><span class="line"></span><br><span class="line">test -x $DAEMON || exit 0</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">case &quot;$1&quot; in</span><br><span class="line">  start)</span><br><span class="line">echo -n &quot;Starting $DESC: &quot;</span><br><span class="line">start-stop-daemon $START_OPTS</span><br><span class="line">echo &quot;$NAME.&quot;</span><br><span class="line">;;</span><br><span class="line">  stop)</span><br><span class="line">echo -n &quot;Stopping $DESC: &quot;</span><br><span class="line">start-stop-daemon $STOP_OPTS</span><br><span class="line">echo &quot;$NAME.&quot;</span><br><span class="line">;;</span><br><span class="line">  restart|force-reload)</span><br><span class="line">echo -n &quot;Restarting $DESC: &quot;</span><br><span class="line">start-stop-daemon $STOP_OPTS</span><br><span class="line">sleep 1</span><br><span class="line">start-stop-daemon $START_OPTS</span><br><span class="line">echo &quot;$NAME.&quot;</span><br><span class="line">;;</span><br><span class="line">  *)</span><br><span class="line">N=/etc/init.d/$NAME</span><br><span class="line">echo &quot;Usage: $N &#123;start|stop|restart|force-reload&#125;&quot; &gt;&amp;2</span><br><span class="line">exit 1</span><br><span class="line">;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure></p><p>Execute it:<br><figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ./run start</span><br><span class="line">Starting daemon-demo: daemon-demo.</span><br><span class="line"></span><br><span class="line"># ./run restart</span><br><span class="line">Restarting daemon-demo: daemon-demo.</span><br><span class="line"></span><br><span class="line"># ./run stop</span><br><span class="line">Stopping daemon-demo: daemon-demo.</span><br></pre></td></tr></table></figure></p><p>Or you can put this script in $PATH</p>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;Server-environment&quot;&gt;&lt;a href=&quot;#Server-environment&quot; class=&quot;headerlink&quot; title=&quot;Server environment&quot;&gt;&lt;/a&gt;Server environment&lt;/h3&gt;&lt;figure class=&quot;highlight plain hljs&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ cat /etc/issue&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  Ubuntu 14.04.5 LTS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ php -v&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  PHP 5.6.32-1+ubuntu14.04.1+deb.sury.org+2 (cli)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="https://liyuliang.cc/tags/PHP/"/>
    
      <category term="Daemon" scheme="https://liyuliang.cc/tags/Daemon/"/>
    
  </entry>
  
</feed>
